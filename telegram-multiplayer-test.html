<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram –ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            opacity: 0.8;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 16px;
            box-sizing: border-box;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .logs {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ –¢–µ—Å—Ç Telegram –ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä–∞</h1>
        
        <div id="telegram-info" class="card">
            <h3>üì± Telegram WebApp Info</h3>
            <div id="webapp-status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>

        <div class="card">
            <h3>üè† –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</h3>
            <input type="text" id="host-name" placeholder="–í–∞—à–µ —ñ–º'—è">
            <button onclick="createRoom()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
            
            <div id="room-created" style="display: none;">
                <div class="status success">
                    –ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏: <span id="room-code"></span>
                </div>
                <button onclick="copyRoomCode()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥</button>
            </div>
        </div>

        <div class="card">
            <h3>üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏</h3>
            <input type="text" id="player-name" placeholder="–í–∞—à–µ —ñ–º'—è">
            <input type="text" id="join-code" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏" maxlength="6" style="text-transform: uppercase;">
            <button onclick="joinRoom()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
        </div>

        <div class="card">
            <h3>üéØ –¢–µ—Å—Ç–æ–≤—ñ –¥—ñ—ó</h3>
            <button onclick="sendAction('correct')">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ</button>
            <button onclick="sendAction('skip')">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
            <button onclick="sendAction('pause')">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
            <button onclick="leaveRoom()">üö™ –ü–æ–∫–∏–Ω—É—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
        </div>

        <div id="status" class="status info">–ì–æ—Ç–æ–≤–∏–π –¥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</div>

        <div class="logs" id="logs">
            <div>üöÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–µ—Å—Ç—É...</div>
        </div>
    </div>

    <script src="env-config.js"></script>
    <script src="build-config.js"></script>
    <script src="multiplayer-telegram.js"></script>

    <script>
        let telegramMP = null;
        let currentRoom = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#f88' : type === 'success' ? '#8f8' : '#0f0';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function showTelegramInfo() {
            const webappStatus = document.getElementById('webapp-status');
            
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                const user = tg.initDataUnsafe?.user;
                
                webappStatus.innerHTML = `
                    <strong>‚úÖ Telegram WebApp –≤–∏—è–≤–ª–µ–Ω–æ</strong><br>
                    <small>–í–µ—Ä—Å—ñ—è: ${tg.version || 'Unknown'}</small><br>
                    ${user ? `
                        <small>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${user.first_name || user.username || 'Unknown'}</small><br>
                        <small>ID: ${user.id}</small>
                    ` : '<small>–î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ</small>'}
                `;
                
                // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —ñ–º–µ–Ω
                if (user) {
                    const name = user.first_name || user.username || 'Telegram User';
                    document.getElementById('host-name').value = name;
                    document.getElementById('player-name').value = name;
                }
                
                // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram WebApp
                tg.ready();
                tg.expand();
            } else {
                webappStatus.innerHTML = `
                    <strong>‚ö†Ô∏è Telegram WebApp –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ</strong><br>
                    <small>–í—ñ–¥–∫—Ä–∏–π—Ç–µ –≤ Telegram –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–π—Ç–µ—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º</small>
                `;
            }
        }

        async function initTelegramMultiplayer() {
            try {
                log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä–∞...');
                
                if (!window.TelegramMultiplayerManager) {
                    throw new Error('TelegramMultiplayerManager –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                }
                
                telegramMP = new window.TelegramMultiplayerManager();
                
                // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
                telegramMP.on('roomCreated', (data) => {
                    log(`‚úÖ –ö—ñ–º–Ω–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–æ: ${data.roomCode}`, 'success');
                    currentRoom = data.roomCode;
                    document.getElementById('room-code').textContent = data.roomCode;
                    document.getElementById('room-created').style.display = 'block';
                    updateStatus(`–ö—ñ–º–Ω–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞: ${data.roomCode}`, 'success');
                });

                telegramMP.on('roomJoined', (data) => {
                    log(`‚úÖ –ü—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å –¥–æ –∫—ñ–º–Ω–∞—Ç–∏: ${data.roomCode}`, 'success');
                    currentRoom = data.roomCode;
                    updateStatus(`–í –∫—ñ–º–Ω–∞—Ç—ñ: ${data.roomCode}`, 'success');
                });

                telegramMP.on('playerJoined', (data) => {
                    log(`üë§ –ì—Ä–∞–≤–µ—Ü—å –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è: ${data.playerName}`, 'info');
                });

                telegramMP.on('playerLeft', (data) => {
                    log(`üëã –ì—Ä–∞–≤–µ—Ü—å –ø—ñ—à–æ–≤: ${data.playerName}`, 'info');
                });

                telegramMP.on('gameAction', (data) => {
                    log(`üéØ –î—ñ—è –≤—ñ–¥ ${data.playerName}: ${data.action}`, 'info');
                });

                telegramMP.on('error', (data) => {
                    log(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.message}`, 'error');
                    updateStatus(`–ü–æ–º–∏–ª–∫–∞: ${data.message}`, 'error');
                });

                log('‚úÖ Telegram –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä –≥–æ—Ç–æ–≤–∏–π', 'success');
                updateStatus('–ì–æ—Ç–æ–≤–∏–π –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è', 'success');
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${error.message}`, 'error');
                updateStatus(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        async function createRoom() {
            const hostName = document.getElementById('host-name').value.trim();
            
            if (!hostName) {
                updateStatus('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è', 'error');
                return;
            }

            if (!telegramMP) {
                updateStatus('–°–ø–æ—á–∞—Ç–∫—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–π—Ç–µ –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä', 'error');
                return;
            }

            try {
                log(`–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏ –¥–ª—è ${hostName}...`);
                updateStatus('–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏...', 'info');
                
                const result = await telegramMP.createRoom({
                    category: '–¢–µ—Å—Ç–æ–≤–∞',
                    roundDuration: 60,
                    maxPlayers: 2
                });
                
                if (!result.success) {
                    throw new Error(result.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É');
                }
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏: ${error.message}`, 'error');
                updateStatus(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        async function joinRoom() {
            const playerName = document.getElementById('player-name').value.trim();
            const roomCode = document.getElementById('join-code').value.trim().toUpperCase();
            
            if (!playerName) {
                updateStatus('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è', 'error');
                return;
            }
            
            if (!roomCode || roomCode.length !== 6) {
                updateStatus('–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (6 —Å–∏–º–≤–æ–ª—ñ–≤)', 'error');
                return;
            }

            if (!telegramMP) {
                updateStatus('–°–ø–æ—á–∞—Ç–∫—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–π—Ç–µ –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä', 'error');
                return;
            }

            try {
                log(`–ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏ ${roomCode} —è–∫ ${playerName}...`);
                updateStatus('–ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è...', 'info');
                
                const result = await telegramMP.joinRoom(roomCode, playerName);
                
                if (!result.success) {
                    throw new Error(result.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è');
                }
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`, 'error');
                updateStatus(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        async function sendAction(action) {
            if (!currentRoom) {
                updateStatus('–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—î–¥–Ω–∞–π—Ç–µ—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏', 'error');
                return;
            }

            if (!telegramMP) {
                updateStatus('–ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', 'error');
                return;
            }

            try {
                log(`–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥—ñ—ó: ${action}`);
                
                await telegramMP.sendGameAction(action, {
                    word: '–¢–ï–°–¢',
                    points: Math.floor(Math.random() * 50) + 10,
                    timestamp: Date.now()
                });
                
                updateStatus(`–î—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞: ${action}`, 'success');
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥—ñ—ó: ${error.message}`, 'error');
                updateStatus(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        async function leaveRoom() {
            if (!currentRoom) {
                updateStatus('–í–∏ –Ω–µ –≤ –∫—ñ–º–Ω–∞—Ç—ñ', 'error');
                return;
            }

            if (!telegramMP) {
                updateStatus('–ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', 'error');
                return;
            }

            try {
                log('–ü–æ–∫–∏–¥–∞–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏...');
                
                await telegramMP.leaveRoom();
                
                currentRoom = null;
                document.getElementById('room-created').style.display = 'none';
                updateStatus('–ü–æ–∫–∏–Ω—É–ª–∏ –∫—ñ–º–Ω–∞—Ç—É', 'info');
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ–∫–∏–¥–∞–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏: ${error.message}`, 'error');
                updateStatus(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            }
        }

        function copyRoomCode() {
            const roomCode = document.getElementById('room-code').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(roomCode).then(() => {
                    updateStatus('–ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', 'success');
                    log('üìã –ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ', 'success');
                });
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                updateStatus('–ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', 'success');
                log('üìã –ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ (fallback)', 'success');
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('load', async () => {
            log('üöÄ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—É...');
            
            showTelegramInfo();
            
            // –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
            let attempts = 0;
            const maxAttempts = 50;
            
            const waitForDependencies = () => {
                attempts++;
                
                if (window.EnvironmentConfig && window.TelegramMultiplayerManager) {
                    log('üì¶ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ');
                    initTelegramMultiplayer();
                } else if (attempts < maxAttempts) {
                    setTimeout(waitForDependencies, 100);
                } else {
                    log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ', 'error');
                    updateStatus('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π', 'error');
                }
            };
            
            waitForDependencies();
        });

        // –û–±—Ä–æ–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É –≤ upper case
        document.getElementById('join-code').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });
    </script>
</body>
</html>
