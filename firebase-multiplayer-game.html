<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞ –≤ —Å–ª–æ–≤–∞ - Firebase Multiplayer</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
    
    <!-- Game styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="themes.css">
    <link rel="stylesheet" href="animations.css">
    
    <!-- Progressive Web App -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        .multiplayer-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .multiplayer-panel.collapsed {
            transform: translateX(250px);
        }
        
        .panel-header {
            padding: 15px;
            background: #4F46E5;
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: between;
            align-items: center;
            cursor: pointer;
        }
        
        .panel-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .connection-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .multiplayer-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mp-button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4F46E5;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .mp-button:hover {
            background: #4338CA;
        }
        
        .mp-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }
        
        .mp-button.secondary {
            background: #6B7280;
        }
        
        .mp-button.danger {
            background: #DC2626;
        }
        
        .room-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }
        
        .player-item {
            background: #f1f3f4;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
        }
        
        .player-host {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        .player-current {
            background: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .toggle-btn {
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 25px;
            height: 40px;
            background: #4F46E5;
            border: none;
            border-radius: 6px 0 0 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .game-sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .game-sync-indicator.visible {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .multiplayer-panel {
                width: 280px;
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω–∞ –≥—Ä–∞ -->
    <div id="gameContainer">
        <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –∑ index.html -->
    </div>
    
    <!-- Firebase Multiplayer Panel -->
    <div id="multiplayerPanel" class="multiplayer-panel collapsed">
        <button class="toggle-btn" onclick="togglePanel()">üë•</button>
        
        <div class="panel-header" onclick="togglePanel()">
            <span>üî• –ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä</span>
            <span id="panelToggle">‚ñ∂</span>
        </div>
        
        <div class="panel-content">
            <div id="connectionStatus" class="connection-status status-offline">
                üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...
            </div>
            
            <div class="multiplayer-buttons">
                <button class="mp-button" onclick="createRoom()" id="createBtn">
                    ‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É
                </button>
                <button class="mp-button" onclick="joinRandomRoom()" id="joinBtn">
                    üîç –ó–Ω–∞–π—Ç–∏ –≥—Ä—É
                </button>
                <button class="mp-button secondary" onclick="joinByCode()" id="codeBtn">
                    üî¢ –í–≤–µ—Å—Ç–∏ –∫–æ–¥
                </button>
                <button class="mp-button danger" onclick="leaveRoom()" id="leaveBtn" style="display: none;">
                    üö™ –ü–æ–∫–∏–Ω—É—Ç–∏
                </button>
            </div>
            
            <div id="roomDisplay" style="display: none;">
                <div class="room-display">
                    <strong>–ö—ñ–º–Ω–∞—Ç–∞:</strong> <span id="roomCode"></span><br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="gameStatus">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
                </div>
                
                <div id="playersSection">
                    <strong>–ì—Ä–∞–≤—Ü—ñ (<span id="playerCount">0</span>/4):</strong>
                    <div id="playersGrid" class="players-grid"></div>
                </div>
                
                <button class="mp-button" onclick="startMultiplayerGame()" id="startGameBtn" style="display: none;">
                    üéÆ –ü–æ—á–∞—Ç–∏ –≥—Ä—É
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sync indicator -->
    <div id="syncIndicator" class="game-sync-indicator">
        üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...
    </div>
    
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –≥—Ä–∏ -->
    <div style="display: none;" id="mainGameLoader">
        <!-- –¢—É—Ç –±—É–¥–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Å–Ω–æ–≤–Ω—É –≥—Ä—É -->
    </div>

    <!-- Scripts -->
    <script src="firebase-config.js"></script>
    <script src="firebase-multiplayer.js"></script>
    <script src="firebase-game-integration.js"></script>
    <script src="words.js"></script>
    <script src="game.js"></script>
    <script src="config.js"></script>
    <script src="localization.js"></script>
    <script src="themes.js" defer></script>
    <script src="speech.js" defer></script>
    <script src="analytics.js" defer></script>
    
    <script>
        // Global variables
        let firebaseMultiplayer = null;
        let gameIntegration = null;
        let mainGame = null;
        let currentRoom = null;
        let isPanelCollapsed = true;
        
        // DOM elements
        const panel = document.getElementById('multiplayerPanel');
        const panelToggle = document.getElementById('panelToggle');
        const connectionStatus = document.getElementById('connectionStatus');
        const roomDisplay = document.getElementById('roomDisplay');
        const roomCode = document.getElementById('roomCode');
        const gameStatus = document.getElementById('gameStatus');
        const playerCount = document.getElementById('playerCount');
        const playersGrid = document.getElementById('playersGrid');
        const syncIndicator = document.getElementById('syncIndicator');
        
        // Buttons
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const codeBtn = document.getElementById('codeBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        
        // Initialize everything
        async function initializeApp() {
            try {
                // Initialize Firebase
                const config = FirebaseConfig.getConfig();
                firebase.initializeApp(config.firebaseConfig);
                
                firebaseMultiplayer = new FirebaseMultiplayerManager();
                await firebaseMultiplayer.initialize();
                
                // Setup event listeners
                setupFirebaseEvents();
                
                // Load main game content
                await loadMainGame();
                
                // Initialize game integration
                gameIntegration = new FirebaseGameIntegration(firebaseMultiplayer, mainGame);
                
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus(false, error.message);
            }
        }
        
        async function loadMainGame() {
            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π HTML –∫–æ–Ω—Ç–µ–Ω—Ç –≥—Ä–∏
                const response = await fetch('index.html');
                const html = await response.text();
                
                // –í–∏—Ç—è–≥—É—î–º–æ body –∫–æ–Ω—Ç–µ–Ω—Ç
                const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                if (bodyMatch) {
                    const gameContainer = document.getElementById('gameContainer');
                    gameContainer.innerHTML = bodyMatch[1];
                    
                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –≥—Ä—É
                    if (typeof WordGame !== 'undefined') {
                        mainGame = new WordGame();
                    }
                }
            } catch (error) {
                console.error('Error loading main game:', error);
            }
        }
        
        function setupFirebaseEvents() {
            firebaseMultiplayer.on('roomJoined', (room) => {
                currentRoom = room;
                updateRoomDisplay();
                showSyncIndicator();
            });
            
            firebaseMultiplayer.on('roomLeft', () => {
                currentRoom = null;
                updateRoomDisplay();
            });
            
            firebaseMultiplayer.on('playerJoined', (player) => {
                updatePlayersDisplay();
                showSyncIndicator();
            });
            
            firebaseMultiplayer.on('playerLeft', (player) => {
                updatePlayersDisplay();
            });
            
            firebaseMultiplayer.on('gameStateUpdated', (gameState) => {
                updateGameStatus(gameState);
                showSyncIndicator();
            });
            
            firebaseMultiplayer.on('gameAction', (action) => {
                handleGameAction(action);
                showSyncIndicator();
            });
            
            firebaseMultiplayer.on('error', (error) => {
                console.error('Firebase error:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä–∞: ' + error.message);
            });
        }
        
        // UI Functions
        function togglePanel() {
            isPanelCollapsed = !isPanelCollapsed;
            panel.classList.toggle('collapsed', isPanelCollapsed);
            panelToggle.textContent = isPanelCollapsed ? '‚ñ∂' : '‚óÄ';
        }
        
        function updateConnectionStatus(isConnected, errorMessage = '') {
            if (isConnected) {
                connectionStatus.className = 'connection-status status-online';
                connectionStatus.innerHTML = 'üü¢ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                enableButtons(true);
            } else {
                connectionStatus.className = 'connection-status status-offline';
                connectionStatus.innerHTML = 'üî¥ –í—ñ–¥–∫–ª—é—á–µ–Ω–æ' + (errorMessage ? `<br><small>${errorMessage}</small>` : '');
                enableButtons(false);
            }
        }
        
        function enableButtons(enabled) {
            createBtn.disabled = !enabled;
            joinBtn.disabled = !enabled;
            codeBtn.disabled = !enabled;
        }
        
        function updateRoomDisplay() {
            if (currentRoom) {
                roomDisplay.style.display = 'block';
                roomCode.textContent = currentRoom.code;
                
                // Show/hide buttons based on role
                const isHost = currentRoom.hostId === firebase.auth().currentUser?.uid;
                leaveBtn.style.display = 'block';
                startGameBtn.style.display = isHost ? 'block' : 'none';
                
                // Hide join buttons
                createBtn.style.display = 'none';
                joinBtn.style.display = 'none';
                codeBtn.style.display = 'none';
                
                updatePlayersDisplay();
            } else {
                roomDisplay.style.display = 'none';
                leaveBtn.style.display = 'none';
                startGameBtn.style.display = 'none';
                
                // Show join buttons
                createBtn.style.display = 'block';
                joinBtn.style.display = 'block';
                codeBtn.style.display = 'block';
            }
        }
        
        function updatePlayersDisplay() {
            if (!currentRoom || !currentRoom.players) {
                playerCount.textContent = '0';
                playersGrid.innerHTML = '';
                return;
            }
            
            const players = Object.values(currentRoom.players);
            playerCount.textContent = players.length;
            
            playersGrid.innerHTML = players.map(player => {
                const isHost = player.id === currentRoom.hostId;
                const isCurrent = player.id === firebase.auth().currentUser?.uid;
                let className = 'player-item';
                if (isHost) className += ' player-host';
                if (isCurrent) className += ' player-current';
                
                return `
                    <div class="${className}">
                        ${player.name}${isHost ? ' üëë' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateGameStatus(gameState) {
            if (gameState && gameState.status) {
                const statusMap = {
                    'waiting': '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è',
                    'starting': '–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞',
                    'playing': '–ì—Ä–∞ –π–¥–µ',
                    'finished': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
                };
                gameStatus.textContent = statusMap[gameState.status] || gameState.status;
            }
        }
        
        function showSyncIndicator() {
            syncIndicator.classList.add('visible');
            setTimeout(() => {
                syncIndicator.classList.remove('visible');
            }, 1500);
        }
        
        // Multiplayer Functions
        async function createRoom() {
            try {
                const playerName = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è:') || `–ì—Ä–∞–≤–µ—Ü—å ${Math.floor(Math.random() * 1000)}`;
                await firebaseMultiplayer.createRoom({
                    maxPlayers: 4,
                    gameMode: 'ukrainian-words',
                    isPrivate: false
                }, playerName);
                
                // Auto-expand panel when room is created
                if (isPanelCollapsed) {
                    togglePanel();
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏: ' + error.message);
            }
        }
        
        async function joinRandomRoom() {
            try {
                const playerName = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è:') || `–ì—Ä–∞–≤–µ—Ü—å ${Math.floor(Math.random() * 1000)}`;
                const joined = await firebaseMultiplayer.joinRandomRoom(playerName);
                
                if (!joined) {
                    if (confirm('–î–æ—Å—Ç—É–ø–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É?')) {
                        await createRoom();
                    }
                }
                
                // Auto-expand panel when joined
                if (isPanelCollapsed) {
                    togglePanel();
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è: ' + error.message);
            }
        }
        
        async function joinByCode() {
            try {
                const code = prompt('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏:');
                if (!code) return;
                
                const playerName = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è:') || `–ì—Ä–∞–≤–µ—Ü—å ${Math.floor(Math.random() * 1000)}`;
                await firebaseMultiplayer.joinRoom(code.toUpperCase(), playerName);
                
                // Auto-expand panel when joined
                if (isPanelCollapsed) {
                    togglePanel();
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è: ' + error.message);
            }
        }
        
        async function leaveRoom() {
            if (confirm('–ü–æ–∫–∏–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –≥—Ä—É?')) {
                try {
                    await firebaseMultiplayer.leaveRoom();
                } catch (error) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: ' + error.message);
                }
            }
        }
        
        async function startMultiplayerGame() {
            try {
                await firebaseMultiplayer.sendGameAction({
                    type: 'START_GAME',
                    data: {
                        difficulty: 'medium',
                        rounds: 6
                    }
                });
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏: ' + error.message);
            }
        }
        
        function handleGameAction(action) {
            // –û–±—Ä–æ–±–∫–∞ –¥—ñ–π –≤—ñ–¥ —ñ–Ω—à–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤
            if (gameIntegration) {
                gameIntegration.handleRemoteAction(action);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
